<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LAST LETTER</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      height:100vh;font-family:'JetBrains Mono',monospace;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      user-select:none;overflow:hidden;position:relative;
      background-size:cover;background-position:center;background-repeat:no-repeat;
      transition:all 0.8s ease;color:#fff;
    }
    body::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,0.5);z-index:-1;}
    h1{font-size:80px;text-shadow:0 0 40px currentColor;margin:30px;}

    .btn{
      padding:18px 60px;font-size:36px;margin:15px;
      background:#fff !important;color:#000 !important;
      border:none;border-radius:20px;cursor:pointer;
      box-shadow:0 0 60px #fff;transition:all .3s;font-weight:bold;
    }
    .btn:hover{transform:scale(1.12);box-shadow:0 0 90px #fff;background:#ddd !important;}
    #change-bg-btn{background:#a0f !important;color:#fff !important;}
    #settings-btn{background:#444 !important;color:#fff !important;position:absolute;top:20px;right:20px;padding:12px 30px;font-size:20px;}

    /* SETTINGS PANEL */
    #settings-panel{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.9);
      background:rgba(0,0,0,0.95);padding:40px 60px;border-radius:30px;
      border:3px solid #fff;box-shadow:0 0 100px rgba(255,255,255,0.6);
      z-index:1000;opacity:0;pointer-events:none;transition:all .4s;
      backdrop-filter:blur(20px);min-width:500px;
    }
    #settings-panel.show{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:all;}
    #settings-panel h2{font-size:40px;text-align:center;margin-bottom:30px;color:#0ff;text-shadow:0 0 20px;}
    .setting-row{margin:20px 0;display:flex;align-items:center;justify-content:space-between;}
    .setting-row label{font-size:24px;color:#ddd;}
    .color-picker{width:80px;height:80px;border-radius:50%;border:4px solid #fff;cursor:pointer;box-shadow:0 0 30px;}
    .mode-btn{padding:10px 20px;margin:5px;font-size:20px;border-radius:15px;cursor:pointer;transition:all .3s;}
    .mode-btn.active{background:#0f0 !important;color:#000 !important;box-shadow:0 0 40px #0f0;}

    #game{display:none;flex-direction:column;align-items:center;position:relative;z-index:1;}
    #word-line{display:flex;align-items:center;justify-content:center;margin:80px 0 40px 0;padding:50px 100px;background:rgba(0,0,0,0.65);border-radius:50px;box-shadow:0 0 100px currentColor;backdrop-filter:blur(12px);border:3px solid currentColor;}
    #letter{font-size:240px;color:#fff;text-shadow:0 0 80px currentColor;font-weight:800;}
    #typed{font-size:200px;color:currentColor;text-shadow:0 0 60px currentColor;margin-left:40px;font-weight:700;}
    #timer{font-size:70px;color:#f33;margin:20px;}
    #hud{position:absolute;top:20px;left:20px;font-size:24px;color:#fff;text-shadow:0 0 10px #000;z-index:10;}
    #msg{position:fixed;bottom:100px;font-size:40px;color:#fff;background:rgba(0,0,0,0.9);padding:15px 50px 15px 40px;border-radius:20px;opacity:0;transition:all .4s;z-index:100;border:2px solid currentColor;display:flex;align-items:center;gap:20px;max-width:90%;}
    #msg.show{opacity:1;bottom:120px;}
    #msg-close{cursor:pointer;width:44px;height:44px;background:#ff3b30;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:26px;box-shadow:0 0 20px #f00;}
    #msg-close:hover{background:#ff0000;}
    #leaderboard{margin-top:50px;background:rgba(0,0,0,0.65);padding:30px 60px;border-radius:30px;border:3px solid currentColor;min-width:400px;box-shadow:0 0 60px currentColor;backdrop-filter:blur(12px);}
    #leaderboard h2{fontb-size:36px;text-align:center;margin-bottom:20px;color:currentColor;text-shadow:0 0 20px currentColor;}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
    #timer.pulse{animation:pulse 0.4s infinite;color:#ff0088;}
  </style>
</head>
<body>

  <div id="start">
    <h1>LAST LETTER</h1>
    <p style="font-size:28px;margin:20px;">You DON'T type the first letter â€” just the rest!</p>
    <button id="play-btn" class="btn">PLAY</button>
    <button id="change-bg-btn" class="btn">CHANGE BACKGROUND</button>
    <button id="settings-btn" class="btn">SETTINGS</button>

    <div id="leaderboard">
      <h2>GLOBAL LEADERBOARD</h2>
      <ol id="lb-list"><div style="color:#888;">Loading...</div></ol>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div id="settings-panel">
    <h2>SETTINGS</h2>
    <div class="setting-row">
      <label>Text Color</label>
      <input type="color" id="color-picker" class="color-picker" value="#ffffff">
    </div>
    <div class="setting-row">
      <button class="btn" style="padding:15px 30px;font-size:24px;" id="remove-bg">REMOVE BACKGROUND</button>
    </div>
    <div class="setting-row">
      <label>Game Mode:</label>
      <div>
        <button class="mode-btn" data-mode="easy">EASY</button>
        <button class="mode-btn active" data-mode="normal">NORMAL</button>
        <button class="mode-btn" data-mode="hardcore">HARDCORE</button>
      </div>
    </div>
    <button class="btn" style="margin-top:30px;" onclick="document.getElementById('settings-panel').classList.remove('show')">CLOSE</button>
  </div>

  <div id="game">
    <div id="hud">Hearts Hearts Hearts | STREAK <strong>0</strong></div>
    <div id="word-line"><div id="letter"></div><div id="typed"></div></div>
    <div id="timer">10</div>
    <div id="msg"><div id="msg-text"></div><div id="msg-close">X</div></div>
  </div>

  <input type="file" id="bg-upload" accept="image/*" style="display:none">

  <script type="module">
    import { Redis } from "https://cdn.jsdelivr.net/npm/@upstash/redis@1/+esm";
    const redis = new Redis({url: "https://exact-dory-25530.upstash.io", token: "AWO6AAIncDIyYmE4OTI5ODI3NDA0NzVmOWJlNDJiYWNkZjA2YjQ0NHAyMjU1MzA"});
    const KEY = "lastletter:global";

    let gameMode = "normal"; // easy | normal | hardcore

    // SETTINGS PANEL
    document.getElementById('settings-btn').addEventListener('click', () => {
      document.getElementById('settings-panel').classList.toggle('show');
    });

    // Text color picker
    document.getElementById('color-picker').addEventListener('input', (e) => {
      document.body.style.color = e.target.value;
      localStorage.setItem('textColor', e.target.value);
    });

    // Remove background
    document.getElementById('remove-bg').addEventListener('click', () => {
      document.body.style.background = "radial-gradient(circle at center, rgba(255,255,255,0.3), #000)";
      document.body.style.backgroundImage = "none";
      localStorage.removeItem('lastletter-bg');
      msg("Background removed!");
    });

    // Game mode buttons
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        gameMode = btn.dataset.mode;
        msg(`Mode: ${gameMode.toUpperCase()}`);
      });
    });

    // Load saved color
    const savedColor = localStorage.getItem('textColor');
    if (savedColor) {
      document.body.style.color = savedColor;
      document.getElementById('color-picker').value = savedColor;
    }

    // Background system
    function applyBackground(url) {
      document.body.style.backgroundImage = `url(${url})`;
      localStorage.setItem('lastletter-bg', url);
    }
    const saved = localStorage.getItem('lastletter-bg');
    if (saved) applyBackground(saved);
    else document.body.style.background = "radial-gradient(circle at center, rgba(255,255,255,0.3), #000)";

    document.getElementById('change-bg-btn').addEventListener('click', () => document.getElementById('bg-upload').click());
    document.getElementById('bg-upload').addEventListener('change', e => {
      const f = e.target.files[0];
      if(f){const r=new FileReader();r.onload=ev=>applyBackground(ev.target.result);r.readAsDataURL(f);}
    });

    // X removes background
    document.getElementById('msg-close').addEventListener('click', () => {
      document.getElementById('msg').classList.remove('show');
      document.body.style.background = "radial-gradient(circle at center, rgba(255,255,255,0.3), #000)";
      document.body.style.backgroundImage = "none";
      localStorage.removeItem('lastletter-bg');
    });

    function msg(t) {
      document.getElementById('msg-text').textContent = t;
      document.getElementById('msg').classList.add('show');
      setTimeout(()=>document.getElementById('msg').classList.remove('show'), 3000);
    }

    // Leaderboard & Game Logic
    async function loadLeaderboard() { /* same as before */ }
    async function saveScore(name, score) { if (gameMode !== "easy") await redis.zadd(KEY, { score, member: name.substring(0,20) || "Anonymous" }); loadLeaderboard(); }
    loadLeaderboard(); setInterval(loadLeaderboard, 15000);

    let words = new Set(), used = new Set(), currentLetter = "", typed = "", lastWord = "";
    let lives = 3, streak = 0, timer = 10, timerId = null, playing = false;
    let wordArray = [];

    fetch("word.txt?" + Date.now())
      .then(r => r.text())
      .then(t => t.split("\n").forEach(w => {
        const wd = w.trim().toLowerCase();
        if (wd.length >= 4 && /^[a-z]+$/.test(wd)) { words.add(wd); wordArray.push(wd); }
        if (wd.length >= 2) wordArray.push(wd); // for easy mode
      }));

    document.getElementById("play-btn").addEventListener("click", () => {
      document.getElementById("start").style.display = "none";
      document.getElementById("game").style.display = "flex";
      lives = gameMode === "hardcore" ? 1 : 3;
      streak = 0; used.clear();
      document.getElementById("hud").innerHTML = "Hearts".repeat(lives) + " | STREAK <strong>0</strong>";
      newRound();
    });

    function newRound() {
      typed = ""; document.getElementById("typed").textContent = "";
      if (streak === 0) {
        const randomWord = wordArray[Math.floor(Math.random() * wordArray.length)];
        lastWord = randomWord; currentLetter = randomWord.slice(-1); used.add(randomWord);
      } else {
        currentLetter = lastWord.slice(-1);
      }
      document.getElementById("letter").textContent = currentLetter.toUpperCase();

      if (gameMode === "easy") {
        document.getElementById("timer").style.display = "none";
        document.getElementById("hud").innerHTML = "STREAK <strong>0</strong> (Easy Mode)";
        return;
      }

      document.getElementById("timer").style.display = "block";
      timer = gameMode === "hardcore" ? 5 : 10;
      document.getElementById("timer").textContent = timer;
      clearInterval(timerId);
      timerId = setInterval(() => {
        timer--; document.getElementById("timer").textContent = timer;
        if (timer <= 3) document.getElementById("timer").classList.add("pulse");
        if (timer <= 0) die();
      }, gameMode === "hardcore" ? 500 : 1000); // 2x speed in hardcore
      playing = true;
    }

    function submit() {
      if (!playing && gameMode !== "easy") return;
      const full = currentLetter + typed.toLowerCase();

      if (gameMode !== "easy") {
        if (typed.length < 3) return msg("Minimum 4 letters!");
        if (!words.has(full)) return msg("Not a word!");
        if (used.has(full)) return msg("Already used!");
      }

      clearInterval(timerId); used.add(full); lastWord = full; streak++;
      document.getElementById("hud").innerHTML = (gameMode === "easy" ? "" : "Hearts".repeat(lives)) + ` | STREAK <strong>${streak}</strong>`;
      setTimeout(newRound, 600);
    }

    async function die() {
      clearInterval(timerId); lives--;
      document.getElementById("hud").innerHTML = "Hearts".repeat(lives) + ` | STREAK <strong>${streak}</strong>`;
      if (lives === 0) {
        playing = false;
        if (streak >= 10 && gameMode !== "easy") {
          let name = prompt(`HIGH SCORE ${streak}!\nEnter your name:`, "Player") || "Anonymous";
          await saveScore(name.trim().substring(0,20), streak);
        }
        msg(gameMode === "easy" ? "Keep going!" : "GAME OVER");
        if (gameMode !== "easy") setTimeout(() => location.reload(), 3000);
      } else {
        msg("Time out!");
        setTimeout(newRound, 1200);
      }
    }

    document.addEventListener("keydown", e => {
      if (!playing && gameMode !== "easy") return;
      if (/^[a-zA-Z]$/.test(e.key)) {
        typed += e.key.toLowerCase();
        document.getElementById("typed").textContent = typed.toUpperCase();
      } else if (e.key === "Backspace") {
        typed = typed.slice(0,-1);
        document.getElementById("typed").textContent = typed.toUpperCase();
      } else if (e.key === "Enter") submit();
    });
  </script>
</body>
</html>
