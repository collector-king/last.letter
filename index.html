<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LAST LETTER</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{height:100vh;background:#000;color:#0f0;font-family:'JetBrains Mono',monospace;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;overflow:hidden;}
    h1{font-size:80px;color:#0f0;text-shadow:0 0 40px #0f0;margin:30px;}
    button{padding:20px 80px;font-size:40px;background:#0f0;color:#000;border:none;border-radius:20px;cursor:pointer;box-shadow:0 0 50px #0f0;}
    button:hover{transform:scale(1.1);}
    #game{display:none;flex-direction:column;align-items:center;}
    #word-line{display:flex;align-items:center;justify-content:center;margin:80px 0 40px 0;padding:50px 100px;background:#000;border-radius:50px;box-shadow:0 0 100px rgba(255,255,255,0.15), inset 0 0 100px rgba(0,0,0,0.8);position:relative;overflow:hidden;border:2px solid #333;}
    #word-line::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,#000,#222,#444,#666,#444,#222,#000);background-size:300% 300%;animation:g 15s ease infinite;opacity:0.8;z-index:1;}
    #letter{font-size:240px;color:#fff;text-shadow:0 0 80px #aaa;position:relative;z-index:2;font-weight:800;}
    #typed{font-size:200px;color:#ccc;text-shadow:0 0 60px #888;margin-left:40px;position:relative;z-index:2;font-weight:700;}
    #timer{font-size:70px;color:#f33;margin:20px;}
    #hud{position:absolute;top:20px;left:20px;font-size:24px;color:#fff;}
    #msg{position:fixed;bottom:100px;font-size:40px;color:#f66;background:rgba(0,0,0,0.7);padding:15px 40px;border-radius:20px;opacity:0;transition:all .4s;}
    #msg.show{opacity:1;bottom:120px;}
    #leaderboard{margin-top:50px;background:#111;padding:30px 60px;border-radius:30px;border:2px solid #333;min-width:400px;box-shadow:0 0 60px rgba(255,255,255,0.1);}
    #leaderboard h2{font-size:36px;text-align:center;margin-bottom:20px;color:#0ff;text-shadow:0 0 20px #0ff;}
    #leaderboard ol{list-style:none;counter-reset:lb;font-size:28px;}
    #leaderboard li{counter-increment:lb;margin:12px 0;color:#ccc;}
    #leaderboard li::before{content:counter(lb) ". ";color:#0f0;font-weight:bold;margin-right:15px;}
    #leaderboard li:first-child{color:#0ff;font-weight:bold;}
    @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
    #timer.pulse{animation:pulse 0.4s infinite}
  </style>
</head>
<body>

  <div id="start">
    <h1>LAST LETTER</h1>
    <p style="font-size:28px;margin:20px;color:#0f0;">You DON'T type the first letter â€” just the rest!</p>
    <button onclick="startGame()">PLAY</button>

    <div id="leaderboard">
      <h2>GLOBAL LEADERBOARD</h2>
      <ol id="lb-list"><div style="color:#666;text-align:center;font-style:italic;">Loading...</div></ol>
    </div>
  </div>

  <div id="game">
    <div id="hud">â™¥â™¥â™¥ | STREAK <strong>0</strong></div>
    <div id="word-line"><div id="letter"></div><div id="typed"></div></div>
    <div id="timer">10</div>
    <div id="msg"></div>
  </div>

  <script type="module">
    import { Redis } from "https://cdn.jsdelivr.net/npm/@upstash/redis@1.35.7/+esm";

    // Parse .env.local for Redis URL
    let redis;
    try {
      const envText = await fetch('./.env.local').then(r => r.text());
      const env = {};
      envText.split('\n').forEach(line => {
        const match = line.match(/^([^=]+)=(.*)$/);
        if (match) env[match[1].trim()] = match[2].trim().replace(/^["']|["']$/g, '');
      });
      const redisUrl = env.Leaderboard_REDIS_URL;
      if (!redisUrl) throw new Error('No Leaderboard_REDIS_URL in .env.local');
      const url = new URL(redisUrl.replace('redis://', 'https://'));
      redis = new Redis({
        url: url.origin + url.pathname,
        token: url.password,
      });
    } catch (e) {
      console.error('Redis connection failed:', e);
      document.getElementById('lb-list').innerHTML = '<div style="color:#c00;">Setup error - check .env.local</div>';
    }

    const KEY = "lastletter:global";

    async function loadLB() {
      if (!redis) return;
      try {
        // Use zrange with negative end for reverse (highest first), withScores true
        const entries = await redis.zrange(KEY, 0, -1, { withScores: true });
        const list = document.getElementById("lb-list");
        list.innerHTML = "";
        if (!entries || entries.length === 0) {
          list.innerHTML = '<div style="color:#666;text-align:center;font-style:italic;">No scores yet â€” be the first!</div>';
          return;
        }
        // Sort by score descending
        const scoredEntries = [];
        for (let i = 0; i < entries.length; i += 2) {
          scoredEntries.push({ name: entries[i], score: parseInt(entries[i + 1]) });
        }
        scoredEntries.sort((a, b) => b.score - a.score);
        const top10 = scoredEntries.slice(0, 10);
        top10.forEach((entry, idx) => {
          const li = document.createElement("li");
          li.textContent = `${entry.name} â€” ${entry.score}${idx === 0 ? ' ðŸ‘‘' : ''}`;
          if (idx === 0) li.style.color = "#0ff";
          list.appendChild(li);
        });
      } catch (e) {
        console.error(e);
        document.getElementById("lb-list").innerHTML = '<div style="color:#c00;">Leaderboard offline</div>';
      }
    }

    async function saveScore(name, score) {
      if (!redis) return;
      try {
        await redis.zadd(KEY, { score, member: name.substring(0, 20) || 'Anonymous' });
        loadLB();
      } catch (e) {
        console.error("Save failed:", e);
      }
    }

    loadLB();
    setInterval(loadLB, 15000);

    // ==================== GAME LOGIC ====================
    const letterEl = document.getElementById('letter');
    const typedEl = document.getElementById('typed');
    const timerEl = document.getElementById('timer');
    const msgEl = document.getElementById('msg');

    let words = new Set();
    let used = new Set();
    let currentLetter = '';
    let typed = '';
    let lives = 3, streak = 0;
    let timer = 10, timerId = null, playing = false;
    let lastWord = '';

    fetch('word.txt?' + Date.now())
      .then(r => r.text())
      .then(text => {
        text.split('\n').forEach(w => {
          const word = w.trim().toLowerCase();
          if (word.length >= 2 && /^[a-z]+$/.test(word)) words.add(word);
        });
      });

    function startGame() {
      document.getElementById('start').style.display = 'none';
      document.getElementById('game').style.display = 'flex';
      lives = 3; streak = 0; used.clear();
      updateHUD();
      newRound();
    }

    function updateHUD() {
      document.getElementById('hud').innerHTML = 
        'â™¥'.repeat(lives) + 'ðŸ’”'.repeat(3 - lives) + ` | STREAK <strong>${streak}</strong>`;
    }

    function newRound() {
      typed = ''; typedEl.textContent = '';
      if (streak === 0) {
        letterEl.textContent = 'ANY â†’';
        currentLetter = '';
      } else {
        currentLetter = lastWord.slice(-1);
        letterEl.textContent = currentLetter.toUpperCase();
      }
      timer = 10; timerEl.textContent = '10'; timerEl.classList.remove('pulse');
      clearInterval(timerId);
      timerId = setInterval(() => {
        timer--; timerEl.textContent = timer;
        if (timer <= 3) timerEl.classList.add('pulse');
        if (timer <= 0) die();
      }, 1000);
      playing = true;
    }

    function submit() {
      if (!playing) return;
      const rest = typed.toLowerCase();
      if (rest.length === 0) return msg("Type something!");
      const fullWord = currentLetter ? currentLetter + rest : rest;
      if (!words.has(fullWord)) return msg("Not a word!");
      if (used.has(fullWord)) return msg("Already used!");

      clearInterval(timerId);
      used.add(fullWord);
      lastWord = fullWord;
      streak++;
      updateHUD();
      setTimeout(newRound, 600);
    }

    async function die() {
      clearInterval(timerId);
      lives--;
      updateHUD();

      if (lives === 0) {
        playing = false;
        if (streak >= 10) {
          let name = prompt(`HIGH SCORE ${streak}!\nEnter your name:`) || 'Anonymous';
          name = name.trim().substring(0, 20);
          await saveScore(name, streak);
        }
        msg("GAME OVER");
        setTimeout(() => location.reload(), 3000);
      } else {
        msg("Time out!");
        setTimeout(newRound, 1200);
      }
    }

    function msg(text) {
      msgEl.textContent = text;
      msgEl.classList.add('show');
      setTimeout(() => msgEl.classList.remove('show'), 1200);
    }

    document.addEventListener('keydown', e => {
      if (!playing) return;
      if (/^[a-zA-Z]$/.test(e.key)) {
        typed += e.key.toLowerCase();
        typedEl.textContent = typed.toUpperCase();
      } else if (e.key === 'Backspace') {
        typed = typed.slice(0, -1);
        typedEl.textContent = typed.toUpperCase();
      } else if (e.key === 'Enter') {
        submit();
      }
    });
  </script>
</body>
</html>
